<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneio de Xadrez SENAI - Morvan Figueiredo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="bg-blue-600 text-white p-6 rounded-lg shadow-lg mb-8">
            <h1 class="text-3xl font-bold">‚ôüÔ∏è Torneio de Xadrez SENAI "Morvan Figueiredo"</h1>
            <p class="text-blue-100 mt-2">Sistema de Gerenciamento de Torneios</p>
        </header>

        <div class="mb-6">
            <div class="flex flex-wrap gap-2 border-b border-gray-300">
                <button onclick="showTab('inscricao')" id="tab-inscricao" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600">
                    üìù Inscri√ß√£o
                </button>
                <button onclick="showTab('competidores')" id="tab-competidores" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600">
                    üë• Competidores
                </button>
                <button onclick="showTab('sorteio')" id="tab-sorteio" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600">
                    üé≤ Sorteio
                </button>
                <button onclick="showTab('partidas')" id="tab-partidas" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600">
                    üèÜ Partidas
                </button>
                <button onclick="showTab('ranking')" id="tab-ranking" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600">
                    üìä Ranking
                </button>
            </div>
        </div>

        <div id="content-inscricao" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">Inscri√ß√£o de Competidor</h2>
                <form id="form-inscricao" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                        <input type="text" id="nome" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Curso *</label>
                        <input type="text" id="curso" required placeholder="Ex: LOG T1, DEV S4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                        <input type="text" id="telefone" required placeholder="Ex: 11 96549-8578" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo *</label>
                        <select id="periodo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecione...</option>
                            <option value="manha">Manh√£</option>
                            <option value="tarde">Tarde</option>
                            <option value="integral">Integral</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dias da Semana *</label>
                        <select id="dias_semana" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecione...</option>
                            <option value="segunda a sexta">Segunda a Sexta</option>
                            <option value="segunda e terca">Segunda e Ter√ßa</option>
                            <option value="quarta e sexta">Quarta e Sexta</option>
                            <option value="sexta">Sexta</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                        Cadastrar Competidor
                    </button>
                </form>
                <div id="msg-inscricao" class="mt-4"></div>
            </div>
        </div>

        <div id="content-competidores" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Lista de Competidores</h2>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('file-csv').click()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                            üìÑ Importar CSV
                        </button>
                        <input type="file" id="file-csv" accept=".csv" style="display: none" onchange="importarCSV(event)">
                        <button onclick="carregarCompetidores()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                            üîÑ Atualizar
                        </button>
                    </div>
                </div>
                
                <div class="mb-4 flex gap-4">
                    <select id="filtro-periodo" onchange="carregarCompetidores()" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Todos os per√≠odos</option>
                        <option value="manha">Manh√£</option>
                        <option value="tarde">Tarde</option>
                        <option value="integral">Integral</option>
                    </select>
                    <select id="filtro-dias" onchange="carregarCompetidores()" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Todos os dias</option>
                        <option value="segunda a sexta">Segunda a Sexta</option>
                        <option value="segunda e terca">Segunda e Ter√ßa</option>
                        <option value="quarta e sexta">Quarta e Sexta</option>
                        <option value="sexta">Sexta</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Curso</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Per√≠odo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dias</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-competidores" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="content-sorteio" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4">Sorteio do Torneio</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar Torneio</label>
                    <select id="torneio-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4">
                        <option value="">Selecione um torneio...</option>
                    </select>
                    
                    <div class="flex gap-4 mb-4">
                        <input type="text" id="novo-torneio" placeholder="Nome do novo torneio" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                        <button onclick="criarTorneio()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
                            Criar Torneio
                        </button>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seed (opcional - para sorteio reprodut√≠vel)</label>
                        <input type="number" id="seed-sorteio" placeholder="Ex: 123" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <button onclick="executarSorteio()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                        üé≤ Executar Sorteio
                    </button>
                </div>

                <div id="resultado-sorteio" class="mt-6"></div>
            </div>
        </div>

        <div id="content-partidas" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Partidas do Torneio</h2>
                    <button onclick="carregarPartidas()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        üîÑ Atualizar
                    </button>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Torneio</label>
                    <select id="torneio-partidas" onchange="carregarPartidas()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Selecione um torneio...</option>
                    </select>
                </div>

                <div id="lista-partidas"></div>
            </div>
        </div>

        <div id="content-ranking" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-6">Ranking e Resultados</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Torneio</label>
                    <select id="torneio-ranking" onchange="carregarRanking()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Selecione um torneio...</option>
                    </select>
                </div>

                <div id="resultado-ranking"></div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-blue-600', 'border-blue-600');
                button.classList.add('text-gray-600', 'border-transparent');
            });
            
            document.getElementById('content-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).classList.remove('text-gray-600', 'border-transparent');
            document.getElementById('tab-' + tabName).classList.add('text-blue-600', 'border-blue-600');

            if (tabName === 'competidores') {
                carregarCompetidores();
            } else if (tabName === 'sorteio') {
                carregarTorneios();
            } else if (tabName === 'partidas') {
                carregarTorneiosPartidas();
            } else if (tabName === 'ranking') {
                carregarTorneiosRanking();
            }
        }

        document.getElementById('form-inscricao').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                nome: document.getElementById('nome').value,
                curso: document.getElementById('curso').value,
                telefone: document.getElementById('telefone').value,
                periodo: document.getElementById('periodo').value,
                dias_semana: document.getElementById('dias_semana').value
            };

            try {
                const response = await fetch('/api/competidores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    document.getElementById('msg-inscricao').innerHTML = '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">Inscri√ß√£o realizada com sucesso!</div>';
                    document.getElementById('form-inscricao').reset();
                } else {
                    throw new Error('Erro ao cadastrar');
                }
            } catch (error) {
                document.getElementById('msg-inscricao').innerHTML = '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Erro ao realizar inscri√ß√£o. Tente novamente.</div>';
            }
        });

        async function carregarCompetidores() {
            const periodo = document.getElementById('filtro-periodo').value;
            const dias = document.getElementById('filtro-dias').value;
            
            let url = '/api/competidores?';
            if (periodo) url += `periodo=${periodo}&`;
            if (dias) url += `dias_semana=${encodeURIComponent(dias)}`;

            try {
                const response = await fetch(url);
                const competidores = await response.json();

                const tbody = document.getElementById('lista-competidores');
                tbody.innerHTML = competidores.map(comp => `
                    <tr>
                        <td class="px-4 py-3">${comp.nome}</td>
                        <td class="px-4 py-3">${comp.curso}</td>
                        <td class="px-4 py-3">${comp.telefone}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">${comp.periodo}</span></td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">${comp.dias_semana}</span></td>
                        <td class="px-4 py-3">
                            <button onclick="deletarCompetidor(${comp.id})" class="text-red-600 hover:text-red-800">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Erro ao carregar competidores:', error);
            }
        }

        async function deletarCompetidor(id) {
            if (!confirm('Tem certeza que deseja excluir este competidor?')) return;
            
            try {
                await fetch(`/api/competidores/${id}`, { method: 'DELETE' });
                carregarCompetidores();
            } catch (error) {
                alert('Erro ao excluir competidor');
            }
        }

        async function importarCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/importar', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                alert(`Importa√ß√£o conclu√≠da!\nImportados: ${result.importados}\nErros: ${result.erros.length}`);
                
                if (result.erros.length > 0) {
                    console.error('Erros na importa√ß√£o:', result.erros);
                }
                
                carregarCompetidores();
            } catch (error) {
                alert('Erro ao importar CSV');
            }
        }

        async function carregarTorneios() {
            try {
                const response = await fetch('/api/torneios');
                const torneios = await response.json();
                
                const select = document.getElementById('torneio-select');
                select.innerHTML = '<option value="">Selecione um torneio...</option>' +
                    torneios.map(t => `<option value="${t.id}">${t.nome} (${t.status})</option>`).join('');
            } catch (error) {
                console.error('Erro ao carregar torneios:', error);
            }
        }

        async function carregarTorneiosPartidas() {
            try {
                const response = await fetch('/api/torneios');
                const torneios = await response.json();
                
                const select = document.getElementById('torneio-partidas');
                select.innerHTML = '<option value="">Selecione um torneio...</option>' +
                    torneios.map(t => `<option value="${t.id}">${t.nome} (${t.status})</option>`).join('');
            } catch (error) {
                console.error('Erro ao carregar torneios:', error);
            }
        }

        async function carregarTorneiosRanking() {
            try {
                const response = await fetch('/api/torneios');
                const torneios = await response.json();
                
                const select = document.getElementById('torneio-ranking');
                select.innerHTML = '<option value="">Selecione um torneio...</option>' +
                    torneios.map(t => `<option value="${t.id}">${t.nome} (${t.status})</option>`).join('');
            } catch (error) {
                console.error('Erro ao carregar torneios:', error);
            }
        }

        async function criarTorneio() {
            const nome = document.getElementById('novo-torneio').value;
            if (!nome) {
                alert('Digite o nome do torneio');
                return;
            }

            try {
                const response = await fetch('/api/torneios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome })
                });

                if (response.ok) {
                    document.getElementById('novo-torneio').value = '';
                    carregarTorneios();
                    alert('Torneio criado com sucesso!');
                }
            } catch (error) {
                alert('Erro ao criar torneio');
            }
        }

        async function executarSorteio() {
            const torneioId = document.getElementById('torneio-select').value;
            if (!torneioId) {
                alert('Selecione um torneio');
                return;
            }

            const seed = document.getElementById('seed-sorteio').value;
            let url = `/api/torneios/${torneioId}/sorteio`;
            if (seed) url += `?seed=${seed}`;

            try {
                const response = await fetch(url, { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('resultado-sorteio').innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                            <h3 class="font-bold mb-2">Sorteio realizado com sucesso!</h3>
                            <p>Fase inicial: ${result.fase_inicial}</p>
                            <p>N√∫mero de partidas: ${result.num_partidas}</p>
                            <p>Byes: ${result.num_byes}</p>
                        </div>
                    `;
                } else {
                    throw new Error(result.detail || 'Erro no sorteio');
                }
            } catch (error) {
                document.getElementById('resultado-sorteio').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        Erro ao executar sorteio: ${error.message}
                    </div>
                `;
            }
        }

        async function carregarPartidas() {
            const torneioId = document.getElementById('torneio-partidas').value;
            if (!torneioId) {
                document.getElementById('lista-partidas').innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/api/torneios/${torneioId}/partidas`);
                const partidas = await response.json();

                const fases = {};
                partidas.forEach(p => {
                    if (!fases[p.fase]) fases[p.fase] = [];
                    fases[p.fase].push(p);
                });

                let html = '';
                Object.keys(fases).forEach(fase => {
                    html += `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4 bg-gray-100 p-3 rounded">${fase.toUpperCase()}</h3>
                            <div class="space-y-4">
                    `;
                    
                    fases[fase].forEach(p => {
                        const statusClass = p.resultado === 'pendente' ? 'bg-yellow-100' : 'bg-green-100';
                        html += `
                            <div class="${statusClass} p-4 rounded-lg">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <p class="font-semibold">${p.jogador1_nome}</p>
                                        <p class="text-sm text-gray-600">vs</p>
                                        <p class="font-semibold">${p.jogador2_nome || 'BYE (passa automaticamente)'}</p>
                                    </div>
                                    <div class="text-right">
                                        ${p.vencedor_nome ? `<span class="px-3 py-1 bg-green-600 text-white rounded-full text-sm">Vencedor: ${p.vencedor_nome}</span>` : ''}
                                    </div>
                                </div>
                                <div class="border-t pt-3 mt-3">
                                    <button onclick="abrirModalPartida(${p.id}, '${p.jogador1_nome}', '${p.jogador2_nome || ''}', ${p.is_bye})" 
                                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                                        ${p.data_hora ? '‚úèÔ∏è Editar' : 'üìÖ Agendar'} Partida
                                    </button>
                                    ${p.data_hora ? `<span class="ml-4 text-sm text-gray-600">üìÖ ${new Date(p.data_hora).toLocaleString('pt-BR')}</span>` : ''}
                                    ${p.local ? `<span class="ml-4 text-sm text-gray-600">üìç ${p.local}</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                });

                document.getElementById('lista-partidas').innerHTML = html;
            } catch (error) {
                console.error('Erro ao carregar partidas:', error);
            }
        }

        function abrirModalPartida(id, j1, j2, isBye) {
            const dataHora = prompt('Data e hora (formato: YYYY-MM-DD HH:MM):', new Date().toISOString().slice(0, 16).replace('T', ' '));
            if (!dataHora) return;

            const local = prompt('Local da partida:', 'SENAI Morvan Figueiredo');
            
            let vencedorId = null;
            if (!isBye && confirm('Deseja registrar o resultado agora?')) {
                const vencedor = prompt(`Quem venceu?\n1 - ${j1}\n2 - ${j2}\n3 - Empate`, '');
                if (vencedor === '1' || vencedor === '2') {
                    vencedorId = vencedor === '1' ? 'j1' : 'j2';
                } else if (vencedor === '3') {
                    vencedorId = 'empate';
                }
            }

            atualizarPartida(id, dataHora, local, vencedorId);
        }

        async function atualizarPartida(id, dataHora, local, resultado) {
            try {
                const body = {
                    data_hora: dataHora,
                    local: local
                };

                if (resultado) {
                    body.resultado = resultado;
                }

                const response = await fetch(`/api/partidas/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    alert('Partida atualizada com sucesso!');
                    carregarPartidas();
                }
            } catch (error) {
                alert('Erro ao atualizar partida');
            }
        }

        async function carregarRanking() {
            const torneioId = document.getElementById('torneio-ranking').value;
            if (!torneioId) {
                document.getElementById('resultado-ranking').innerHTML = '';
                return;
            }

            try {
                const [partidasResp, campeaoResp] = await Promise.all([
                    fetch(`/api/torneios/${torneioId}/partidas`),
                    fetch(`/api/torneios/${torneioId}/campeao`)
                ]);

                const partidas = await partidasResp.json();
                const campeaoData = await campeaoResp.json();

                let html = '';

                if (campeaoData.finalizado && campeaoData.campeao) {
                    html += `
                        <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-8 rounded-lg mb-6 text-center">
                            <h3 class="text-3xl font-bold mb-2">üèÜ CAMPE√ÉO üèÜ</h3>
                            <p class="text-2xl font-semibold">${campeaoData.campeao.nome}</p>
                            <p class="text-lg">${campeaoData.campeao.curso}</p>
                        </div>
                    `;
                }

                html += '<h3 class="text-xl font-bold mb-4">Chaveamento Completo</h3>';
                
                const fases = {};
                partidas.forEach(p => {
                    if (!fases[p.fase]) fases[p.fase] = [];
                    fases[p.fase].push(p);
                });

                Object.keys(fases).forEach(fase => {
                    html += `
                        <div class="mb-4">
                            <h4 class="font-semibold text-lg mb-2 text-gray-700">${fase.toUpperCase()}</h4>
                            <div class="space-y-2">
                    `;
                    
                    fases[fase].forEach(p => {
                        html += `
                            <div class="bg-gray-50 p-3 rounded border-l-4 ${p.vencedor_nome ? 'border-green-500' : 'border-gray-300'}">
                                <div class="flex justify-between">
                                    <span>${p.jogador1_nome} vs ${p.jogador2_nome || 'BYE'}</span>
                                    ${p.vencedor_nome ? `<span class="font-semibold text-green-600">‚Üí ${p.vencedor_nome}</span>` : '<span class="text-gray-500">Pendente</span>'}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                });

                document.getElementById('resultado-ranking').innerHTML = html;
            } catch (error) {
                console.error('Erro ao carregar ranking:', error);
            }
        }

        showTab('inscricao');
    </script>
</body>
</html>
